"""
Astrology Service - AI Interpreter (DeepSeek API)
"""
import asyncio
from pathlib import Path
from typing import Optional, List

from loguru import logger

from .config import (
    DEEPSEEK_API_KEY, 
    DEEPSEEK_BASE_URL, 
    DEEPSEEK_MODEL,
    PROMPTS_DIR,
    LIFE_SPHERES,
)
from .calculator import ChartData


class AstrologyInterpreter:
    """AI-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±–∞–∑–µ DeepSeek"""
    
    def __init__(self):
        self._client = None
        self._prompts_cache: dict[str, str] = {}
        self._init_client()
    
    def _init_client(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
        if not DEEPSEEK_API_KEY:
            logger.warning("DEEPSEEK_API_KEY not set. AI interpretations will be limited.")
            return
        
        try:
            from openai import AsyncOpenAI
            self._client = AsyncOpenAI(
                api_key=DEEPSEEK_API_KEY,
                base_url=DEEPSEEK_BASE_URL,
            )
            logger.info(f"DeepSeek client initialized (model: {DEEPSEEK_MODEL})")
        except ImportError:
            logger.warning("openai library not installed. AI interpretations will be limited.")
    
    def _load_prompt(self, prompt_name: str) -> str:
        """
        –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞.
        
        Args:
            prompt_name: –ò–º—è –ø—Ä–æ–º–ø—Ç–∞ (–±–µ–∑ .txt)
            
        Returns:
            –¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞
        """
        if prompt_name in self._prompts_cache:
            return self._prompts_cache[prompt_name]
        
        prompt_path = PROMPTS_DIR / f"{prompt_name}.txt"
        
        if prompt_path.exists():
            prompt = prompt_path.read_text(encoding="utf-8")
            self._prompts_cache[prompt_name] = prompt
            return prompt
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        return self._get_default_prompt(prompt_name)
    
    def _get_default_prompt(self, prompt_name: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"""
        defaults = {
            "natal_chart": """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. 
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –∏ –¥–∞–π –≥–ª—É–±–æ–∫—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –ª–∏—á–Ω–æ—Å—Ç–∏.

–î–ê–ù–ù–´–ï –ö–ê–†–¢–´:
{chart_context}

–ó–ê–î–ê–ß–ê:
1. –û–ø–∏—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —á–µ—Ä—Ç—ã –ª–∏—á–Ω–æ—Å—Ç–∏ (–°–æ–ª–Ω—Ü–µ, –õ—É–Ω–∞, –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç)
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ –∑–æ–Ω—ã —Ä–æ—Å—Ç–∞
3. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
4. –£–∫–∞–∂–∏ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ —Å—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Ç–µ–ø–ª–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ.
–î–ª–∏–Ω–∞: 800-1200 —Å–ª–æ–≤.""",

            "child_chart": """–¢—ã –¥–µ—Ç—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–ø—Å–∏—Ö–æ–ª–æ–≥ —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏.
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É —Ä–µ–±—ë–Ω–∫–∞ –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—è–º.

–î–ê–ù–ù–´–ï –ö–ê–†–¢–´ –†–ï–ë–Å–ù–ö–ê:
{chart_context}

–ó–ê–î–ê–ß–ê:
1. –û–ø–∏—à–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∑–¥–æ—Ä–æ–≤—å–µ
2. –†–∞—Å–∫—Ä–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ —Ä–µ–±—ë–Ω–∫–∞
3. –û–ø—Ä–µ–¥–µ–ª–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∏–ª—å –æ–±—É—á–µ–Ω–∏—è
4. –£–∫–∞–∂–∏ —Ç–∞–ª–∞–Ω—Ç—ã –∏ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç–∏
5. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—é
6. –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∏–¥—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü–∏—à–∏ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –ø–æ–Ω—è—Ç–Ω–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ.
–î–ª–∏–Ω–∞: 1000-1500 —Å–ª–æ–≤.""",

            "love_horoscope": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ª—é–±–æ–≤–Ω—É—é —Å—Ñ–µ—Ä—É –ø–æ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ.

–î–ê–ù–ù–´–ï –ö–ê–†–¢–´:
{chart_context}

–ó–ê–î–ê–ß–ê:
1. –û–ø–∏—à–∏ —Å—Ç–∏–ª—å –ª—é–±–≤–∏ (–í–µ–Ω–µ—Ä–∞ –∏ –ú–∞—Ä—Å)
2. –†–∞—Å–∫—Ä–æ–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö
3. –û–ø–∏—à–∏ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –ø–æ –∫–∞—Ä—Ç–µ
4. –£–∫–∞–∂–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ –ª—é–±–≤–∏
5. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –æ—Ç–Ω–æ—à–µ–Ω–∏–π

–ü–∏—à–∏ —Ç–µ–ø–ª–æ –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ.
–î–ª–∏–Ω–∞: 600-900 —Å–ª–æ–≤.""",

            "daily_horoscope": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥, —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
–°–æ—Å—Ç–∞–≤—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.

–î–ê–ù–ù–´–ï –ö–ê–†–¢–´:
{chart_context}

–¢–ï–ö–£–©–ê–Ø –î–ê–¢–ê: {date}

–ó–ê–î–ê–ß–ê:
1. –û–ø–∏—à–∏ –æ–±—â–∏–π –Ω–∞—Å—Ç—Ä–æ–π –¥–Ω—è
2. –£–∫–∞–∂–∏ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ —á–∞—Å—ã
3. –î–∞–π —Å–æ–≤–µ—Ç –¥–Ω—è
4. –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–ª–æ–∂–Ω–æ—Å—Ç—è—Ö

–ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ–∑–∏—Ç–∏–≤–Ω–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ.
–î–ª–∏–Ω–∞: 150-250 —Å–ª–æ–≤.""",

            "forecast": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥-–ø—Ä–æ–≥–Ω–æ–∑–∏—Å—Ç.
–°–æ—Å—Ç–∞–≤—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.

–î–ê–ù–ù–´–ï –ö–ê–†–¢–´:
{chart_context}

–ü–ï–†–ò–û–î: {period}
–°–§–ï–†–´: {spheres}

–ó–ê–î–ê–ß–ê:
–î–ª—è –∫–∞–∂–¥–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ñ–µ—Ä—ã:
1. –û–ø–∏—à–∏ –æ–±—â–∏–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –ø–µ—Ä–∏–æ–¥–∞
2. –£–∫–∞–∂–∏ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –∏ —Å–ª–æ–∂–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
3. –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ü–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, –ø–æ —Å—Ñ–µ—Ä–∞–º.
–î–ª–∏–Ω–∞: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ñ–µ—Ä (200-400 —Å–ª–æ–≤ –Ω–∞ —Å—Ñ–µ—Ä—É).""",

            "events_calendar": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥, —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π.
–°–æ—Å—Ç–∞–≤—å –≥—Ä–∞—Ñ–∏–∫ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –Ω–∞ –ø–µ—Ä–∏–æ–¥.

–î–ê–ù–ù–´–ï –ö–ê–†–¢–´:
{chart_context}

–ü–ï–†–ò–û–î: {period}

–ó–ê–î–ê–ß–ê:
–°–æ—Å—Ç–∞–≤—å —Å–ø–∏—Å–æ–∫ –≤–∞–∂–Ω—ã—Ö –¥–∞—Ç —Å:
1. –î–∞—Ç–æ–π –∏ —Ç–∏–ø–æ–º —Å–æ–±—ã—Ç–∏—è (—Ç—Ä–∞–Ω–∑–∏—Ç, –∞—Å–ø–µ–∫—Ç)
2. –í–ª–∏—è–Ω–∏–µ–º –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

–§–æ—Ä–º–∞—Ç:
üìÖ [–¥–∞—Ç–∞]
üî¥/üü¢ [—Å–æ–±—ã—Ç–∏–µ]
üí° [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]

–î–ª–∏–Ω–∞: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–µ—Ä–∏–æ–¥–∞.""",

            "transit": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π —Ç–µ–∫—É—â–∏–µ –≤–ª–∏—è–Ω–∏—è.
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—É—â–∏–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã.

–î–ê–ù–ù–´–ï –ö–ê–†–¢–´:
{chart_context}

–¢–ï–ö–£–©–ê–Ø –î–ê–¢–ê: {date}

–ó–ê–î–ê–ß–ê:
1. –û–ø–∏—à–∏ —Ç–µ–∫—É—â–∏–µ –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–µ –≤–ª–∏—è–Ω–∏—è
2. –ö–∞–∫ –æ–Ω–∏ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É
3. –°–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥–ª–∏—Ç—Å—è –≤–ª–∏—è–Ω–∏–µ
4. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–î–ª–∏–Ω–∞: 400-600 —Å–ª–æ–≤.""",

            "compatibility": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∏–Ω–∞—Å—Ç—Ä–∏—é –¥–≤—É—Ö –∫–∞—Ä—Ç.

–ö–ê–†–¢–ê 1:
{chart1_context}

–ö–ê–†–¢–ê 2:
{chart2_context}

–ó–ê–î–ê–ß–ê:
1. –û–ø–∏—à–∏ –æ–±—â—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–∞—Ä—ã
3. –£–∫–∞–∂–∏ –∑–æ–Ω—ã –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
4. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏

–ü–∏—à–∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ, –æ—Ç–º–µ—á–∞—è –∏ –ø–ª—é—Å—ã, –∏ –º–∏–Ω—É—Å—ã.
–î–ª–∏–Ω–∞: 800-1200 —Å–ª–æ–≤.""",
        }
        
        return defaults.get(prompt_name, "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:\n{chart_context}")
    
    async def interpret(
        self,
        prompt_name: str,
        chart_data: ChartData,
        **kwargs
    ) -> tuple[str, int]:
        """
        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é.
        
        Args:
            prompt_name: –ò–º—è –ø—Ä–æ–º–ø—Ç–∞
            chart_data: –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
            **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            
        Returns:
            (—Ç–µ–∫—Å—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤)
        """
        if not self._client:
            return self._mock_interpretation(prompt_name), 0
        
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç
            prompt_template = self._load_prompt(prompt_name)
            
            # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            prompt = prompt_template.format(
                chart_context=chart_data.ai_context or self._format_chart_context(chart_data),
                **kwargs
            )
            
            # –í—ã–∑—ã–≤–∞–µ–º API —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            logger.info(f"Calling DeepSeek API for {prompt_name}...")
            response = await asyncio.wait_for(
                self._client.chat.completions.create(
                    model=DEEPSEEK_MODEL,
                    messages=[
                        {"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.7,
                    max_tokens=4000,
                ),
                timeout=180  # 3 –º–∏–Ω—É—Ç—ã —Ç–∞–π–º–∞—É—Ç
            )
            
            text = response.choices[0].message.content
            tokens = response.usage.total_tokens if response.usage else 0
            logger.info(f"DeepSeek API response received: {tokens} tokens")
            
            return text, tokens
            
        except asyncio.TimeoutError:
            logger.error(f"DeepSeek API timeout for {prompt_name}")
            return self._mock_interpretation(prompt_name), 0
        except Exception as e:
            logger.exception(f"Error generating interpretation: {e}")
            return self._mock_interpretation(prompt_name), 0
    
    async def interpret_natal(self, chart_data: ChartData) -> tuple[str, int]:
        """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã"""
        return await self.interpret("natal_chart", chart_data)
    
    async def interpret_child(self, chart_data: ChartData) -> tuple[str, int]:
        """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –¥–µ—Ç—Å–∫–æ–π –∫–∞—Ä—Ç—ã"""
        return await self.interpret("child_chart", chart_data)
    
    async def interpret_love(self, chart_data: ChartData) -> tuple[str, int]:
        """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –ª—é–±–æ–≤–Ω–æ–π —Å—Ñ–µ—Ä—ã"""
        return await self.interpret("love_horoscope", chart_data)
    
    async def interpret_daily(self, chart_data: ChartData, date: str) -> tuple[str, int]:
        """–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø"""
        return await self.interpret("daily_horoscope", chart_data, date=date)
    
    async def interpret_forecast(
        self, 
        chart_data: ChartData, 
        period: str,
        spheres: List[str]
    ) -> tuple[str, int]:
        """–ê—Å—Ç—Ä–æ–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –ø–µ—Ä–∏–æ–¥"""
        spheres_text = ", ".join([LIFE_SPHERES.get(s, s) for s in spheres])
        return await self.interpret("forecast", chart_data, period=period, spheres=spheres_text)
    
    async def interpret_events(self, chart_data: ChartData, period: str) -> tuple[str, int]:
        """–ì—Ä–∞—Ñ–∏–∫ —Å–æ–±—ã—Ç–∏–π"""
        return await self.interpret("events_calendar", chart_data, period=period)
    
    async def interpret_transits(self, chart_data: ChartData, date: str) -> tuple[str, int]:
        """–¢–µ–∫—É—â–∏–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã"""
        return await self.interpret("transit", chart_data, date=date)
    
    async def interpret_compatibility(
        self, 
        chart1: ChartData, 
        chart2: ChartData
    ) -> tuple[str, int]:
        """–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–≤—É—Ö –∫–∞—Ä—Ç"""
        if not self._client:
            return self._mock_interpretation("compatibility"), 0
        
        try:
            prompt_template = self._load_prompt("compatibility")
            prompt = prompt_template.format(
                chart1_context=chart1.ai_context or self._format_chart_context(chart1),
                chart2_context=chart2.ai_context or self._format_chart_context(chart2),
            )
            
            response = await self._client.chat.completions.create(
                model=DEEPSEEK_MODEL,
                messages=[
                    {"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.7,
                max_tokens=2500,
            )
            
            text = response.choices[0].message.content
            tokens = response.usage.total_tokens if response.usage else 0
            
            return text, tokens
            
        except Exception as e:
            logger.exception(f"Error generating compatibility: {e}")
            return self._mock_interpretation("compatibility"), 0
    
    async def interpret_question(
        self,
        charts: List[ChartData],
        names: List[str],
        question: str
    ) -> tuple[str, int]:
        """–û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ä—Ç"""
        if not self._client:
            return self._mock_interpretation("question"), 0
        
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç
            charts_context = ""
            for i, (chart, name) in enumerate(zip(charts, names)):
                charts_context += f"\n=== {name} ===\n"
                charts_context += chart.ai_context or self._format_chart_context(chart)
                charts_context += "\n"
            
            prompt = f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å, –∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –Ω–µ–≥–æ, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –Ω–∞—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–∞—Ö.

–ù–ê–¢–ê–õ–¨–ù–´–ï –ö–ê–†–¢–´:
{charts_context}

–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{question}

–ó–ê–î–ê–ß–ê:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ä—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
2. –î–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
3. –£–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç, –∫–æ—Ç–æ—Ä—ã–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é
4. –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ, –Ω–æ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –î–ª–∏–Ω–∞: 600-1000 —Å–ª–æ–≤."""

            response = await self._client.chat.completions.create(
                model=DEEPSEEK_MODEL,
                messages=[
                    {"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.7,
                max_tokens=3000,
            )
            
            text = response.choices[0].message.content
            tokens = response.usage.total_tokens if response.usage else 0
            
            return text, tokens
            
        except Exception as e:
            logger.exception(f"Error generating question answer: {e}")
            return self._mock_interpretation("question"), 0
    
    def _format_chart_context(self, chart: ChartData) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
        lines = [
            f"–°–æ–ª–Ω—Ü–µ: {chart.sun_sign}",
            f"–õ—É–Ω–∞: {chart.moon_sign}",
            f"–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç: {chart.ascendant_sign}",
            "",
            "–ü–ª–∞–Ω–µ—Ç—ã:",
        ]
        
        for planet, data in chart.planets.items():
            lines.append(f"  {planet}: {data.get('sign')} {data.get('degree', 0):.1f}¬∞")
        
        return "\n".join(lines)
    
    def _mock_interpretation(self, prompt_name: str) -> str:
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ API"""
        mocks = {
            "natal_chart": """üåü **–í–∞—à –∞—Å—Ç—Ä–æ–ø–æ—Ä—Ç—Ä–µ—Ç**

–í–∞—à–µ –°–æ–ª–Ω—Ü–µ –≤ –†—ã–±–∞—Ö –Ω–∞–¥–µ–ª—è–µ—Ç –≤–∞—Å –≥–ª—É–±–æ–∫–æ–π –∏–Ω—Ç—É–∏—Ü–∏–µ–π –∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–º –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º. –í—ã —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –∫ —ç–º–æ—Ü–∏—è–º –æ–∫—Ä—É–∂–∞—é—â–∏—Ö –∏ –æ–±–ª–∞–¥–∞–µ—Ç–µ –≤—Ä–æ–∂–¥—ë–Ω–Ω–æ–π —ç–º–ø–∞—Ç–∏–µ–π.

–õ—É–Ω–∞ –≤–æ –õ—å–≤–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞—à–µ–π –Ω–∞—Ç—É—Ä–µ —è—Ä–∫–æ—Å—Ç–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∏–∑–Ω–∞–Ω–∏–∏. –í—ã —É–º–µ–µ—Ç–µ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –¥—Ä—É–≥–∏—Ö –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤–æ–∫—Ä—É–≥ —Å–µ–±—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø—Ä–∞–∑–¥–Ω–∏–∫–∞.

–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç –≤ –†–∞–∫–µ –¥–µ–ª–∞–µ—Ç –≤–∞—Å –∑–∞–±–æ—Ç–ª–∏–≤—ã–º –∏ –¥–æ–º–∞—à–Ω–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º. –î–ª—è –≤–∞—Å –≤–∞–∂–Ω—ã —Å–µ–º—å—è –∏ –±–ª–∏–∑–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –†–∞–∑–≤–∏–≤–∞–π—Ç–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ —Å–≤–æ–∏—Ö –≥—Ä–∞–Ω–∏—Ü–∞—Ö
- –î–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ç—É–∏—Ü–∏–∏

*–≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è. –î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ DEEPSEEK_API_KEY.*""",

            "daily_horoscope": """‚òÄÔ∏è **–ì–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è**

–°–µ–≥–æ–¥–Ω—è –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –∏ –æ–±—â–µ–Ω–∏—è. –õ—É–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∞—à–∏ –Ω–∞—á–∏–Ω–∞–Ω–∏—è.

**–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ —á–∞—Å—ã:** 10:00-14:00
**–°–æ–≤–µ—Ç –¥–Ω—è:** –î–æ–≤–µ—Ä—å—Ç–µ—Å—å –∏–Ω—Ç—É–∏—Ü–∏–∏

*–≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è.*""",

            "compatibility": """üíï **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**

–í–∞—à–∞ –ø–∞—Ä–∞ –æ–±–ª–∞–¥–∞–µ—Ç —Ö–æ—Ä–æ—à–∏–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π. –°–æ–ª–Ω–µ—á–Ω—ã–µ –∑–Ω–∞–∫–∏ —Å–æ–∑–¥–∞—é—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –¥–∏–Ω–∞–º–∏–∫—É.

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:** –≤–∑–∞–∏–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞
**–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:** –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è

*–≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è.*""",

            "question": """‚ùì **–û—Ç–≤–µ—Ç –∞—Å—Ç—Ä–æ–ª–æ–≥–∞**

–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –≤–∞–∂–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –≤–∞—à–µ–π –∂–∏–∑–Ω–∏.

–ü–æ–ª–æ–∂–µ–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–≤–æ—é –∏–Ω—Ç—É–∏—Ü–∏—é ‚Äî –æ–Ω–∞ —Å–µ–π—á–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ —Å–∏–ª—å–Ω–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–æ–≤–µ—Ä—è–π—Ç–µ —Å–≤–æ–∏–º –æ—â—É—â–µ–Ω–∏—è–º
- –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å —Å –≤–∞–∂–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏
- –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∑–Ω–∞–∫–∏ –≤–æ–∫—Ä—É–≥ –≤–∞—Å

*–≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DEEPSEEK_API_KEY –¥–ª—è –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏.*""",
        }
        
        return mocks.get(prompt_name, "*–î–µ–º–æ-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DEEPSEEK_API_KEY –¥–ª—è –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏.*")


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
interpreter = AstrologyInterpreter()
