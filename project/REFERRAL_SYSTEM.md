# –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞—Ç—å –∫–æ–º–∏—Å—Å–∏—é —Å –∏—Ö –ø–æ–∫—É–ø–æ–∫.

### –î–≤–∞ —Ç–∏–ø–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:

| –¢–∏–ø | –§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏ | –ö–æ–º–∏—Å—Å–∏—è |
|-----|---------------|----------|
| –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | `ref_XXXXX` | 10% (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| –ü–∞—Ä—Ç–Ω—ë—Ä | `partner_XXXXX` | 15-30% (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è) |

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A (—Ä–µ—Ñ–µ—Ä–µ—Ä) ‚Üí –¥–µ–ª–∏—Ç—Å—è —Å—Å—ã–ª–∫–æ–π ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B (—Ä–µ—Ñ–µ—Ä–∞–ª) —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
```

**–°—Å—ã–ª–∫–∞:**
```
https://t.me/bot?start=ref_ABC123
https://t.me/bot?start=partner_XYZ789
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ /start:**

1. –ü–∞—Ä—Å–∏—Ç—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–µ—Ñ–µ—Ä–µ—Ä —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ù–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–µ—Ñ–µ—Ä–µ—Ä –ø–æ –∫–æ–¥—É
4. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å `Referral`
5. –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `Partner.total_referrals`

### 2. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏

```
–†–µ—Ñ–µ—Ä–∞–ª —Ç—Ä–∞—Ç–∏—Ç GTON ‚Üí –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é
```

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `CoreAPI.deduct_balance()` (—Å–ø–∏—Å–∞–Ω–∏–µ GTON)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `ReferralCommissionService.process_commission()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. –ù–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å (`Referral`)
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏:
   - –û–±—ã—á–Ω—ã–π —Ä–µ—Ñ–µ—Ä–µ—Ä: 10%
   - –ü–∞—Ä—Ç–Ω—ë—Ä: –µ–≥–æ `level1_percent` (15-30%)
3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–º–∏—Å—Å–∏—è: `amount * percent / 100`
4. –ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
5. –°–æ–∑–¥–∞—ë—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `credit` —Å `source="referral"`
6. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ `Referral`
7. –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `Partner.balance` –∏ `Partner.total_earned`
8. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å `Commission`

---

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### Referral (—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å)

```python
class Referral:
    id: int
    referrer_id: int          # –ö—Ç–æ –ø—Ä–∏–≤—ë–ª
    referred_id: int          # –ö–æ–≥–æ –ø—Ä–∏–≤–µ–ª–∏
    partner_id: int | None    # ID –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    level: int = 1            # –£—Ä–æ–≤–µ–Ω—å (1 = –ø—Ä—è–º–æ–π)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_payments: Decimal   # –°—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    total_commission: Decimal # –°—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π
    is_active: bool
    
    # –î–∞—Ç—ã
    created_at: datetime
    first_payment_at: datetime | None
    last_payment_at: datetime | None
```

### Partner (–ø–∞—Ä—Ç–Ω—ë—Ä)

```python
class Partner:
    id: int
    user_id: int              # –°–≤—è–∑—å —Å User
    referral_code: str        # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
    status: str               # pending/active/blocked
    
    # –ö–æ–º–∏—Å—Å–∏–∏
    level1_percent: Decimal   # % —Å –ø—Ä—è–º—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (15-30)
    
    # –ë–∞–ª–∞–Ω—Å
    balance: Decimal          # –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å GTON
    frozen_balance: Decimal   # –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π (–ø—Ä–∏ –≤—ã–≤–æ–¥–µ)
    total_earned: Decimal     # –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
    total_withdrawn: Decimal  # –í—Å–µ–≥–æ –≤—ã–≤–µ–¥–µ–Ω–æ
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_referrals: int      # –í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```

### Commission (–∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–∏—Å—Å–∏–π)

```python
class Commission:
    id: int
    referrer_id: int          # –ö—Ç–æ –ø–æ–ª—É—á–∏–ª –∫–æ–º–∏—Å—Å–∏—é
    referred_id: int          # –û—Ç –∫–æ–≥–æ
    referral_id: int          # –°–≤—è–∑—å —Å Referral
    
    source_amount: Decimal    # –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏
    commission_amount: Decimal # –°—É–º–º–∞ –∫–æ–º–∏—Å—Å–∏–∏
    commission_percent: Decimal # –ü—Ä–æ—Ü–µ–Ω—Ç
    level: int = 1
    
    service_id: str           # –ö–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å
    action: str               # –ö–∞–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    
    source_transaction_id: int      # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–ø–∏—Å–∞–Ω–∏—è
    commission_transaction_id: int  # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
```

### Payout (–∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥)

```python
class Payout:
    id: int
    partner_id: int
    
    amount_gton: Decimal      # –°—É–º–º–∞ –≤ GTON
    fee_gton: Decimal         # –ö–æ–º–∏—Å—Å–∏—è –≤ GTON
    amount_fiat: Decimal      # –°—É–º–º–∞ –≤ —Ñ–∏–∞—Ç–µ
    currency: str = "RUB"
    gton_rate: Decimal        # –ö—É—Ä—Å –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞—è–≤–∫–∏
    
    method: str               # card/sbp
    details: JSON             # {"card": "4276****1234"}
    status: str               # pending/approved/rejected
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)

| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –ö–ª—é—á | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-----------|------|--------------|
| –í–∫–ª—é—á–µ–Ω–∞ | `referral.enabled` | true |
| –ö–æ–º–∏—Å—Å–∏—è —É—Ä–æ–≤–µ–Ω—å 1 | `referral.default_level1` | 10% |
| –ö–æ–º–∏—Å—Å–∏—è —É—Ä–æ–≤–µ–Ω—å 2 | `referral.default_level2` | 0% |
| –£—Ä–æ–≤–µ–Ω—å 2 –≤–∫–ª—é—á—ë–Ω | `referral.level2_enabled` | false |
| –ú–∏–Ω. –≤—ã–≤–æ–¥ | `referral.min_payout` | 500 ‚ÇΩ |

### –ö–æ–º–∏—Å—Å–∏–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤

–ö–∞–∂–¥—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä –∏–º–µ–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π `level1_percent`, –∫–æ—Ç–æ—Ä—ã–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏.

---

## Telegram UI

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü–∞—Ä—Ç–Ω—ë—Ä–∫–∞ (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é):**
```
üë• –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
–†–µ—Ñ–µ—Ä–∞–ª–æ–≤: 5
–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: 150 GTON

üîó –í–∞—à–∞ —Å—Å—ã–ª–∫–∞:
https://t.me/bot?start=ref_ABC123

[üìã –ú–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã]
[üí∞ –°—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º]
```

**–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç (–¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤):**
```
ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç

üí∞ –ë–∞–ª–∞–Ω—Å: 50.5 GTON (~5050 ‚ÇΩ)
üìä –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: 25
üíµ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: 500 GTON

üîó –í–∞—à–∞ —Å—Å—ã–ª–∫–∞:
https://t.me/bot?start=partner_XYZ789

[üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]
[üí∏ –í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞]
```

### –î–ª—è –∞–¥–º–∏–Ω–∞

**–ê–¥–º–∏–Ω ‚Üí –ü–∞—Ä—Ç–Ω—ë—Ä—ã:**
- –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
- –ó–∞—è–≤–∫–∏ –Ω–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ
- –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–π

---

## –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤

### 1. –ü–∞—Ä—Ç–Ω—ë—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤—ã–≤–æ–¥

```
–ü–∞—Ä—Ç–Ω—ë—Ä ‚Üí –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç ‚Üí –í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞
‚Üí –í—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ (–ö–∞—Ä—Ç–∞/–°–ë–ü)
‚Üí –í–≤–æ–¥–∏—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
```

### 2. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞—è–≤–∫–∞

```python
PayoutService.create_payout_request(
    partner_id=1,
    amount_gton=Decimal("30"),
    method="card",
    details={"card": "4276****1234"},
    currency="RUB"
)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å
2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–º–∏—Å—Å–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è GTON ‚Üí RUB –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫—É—Ä—Å—É
4. –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è —Å—É–º–º–∞ (`frozen_balance += amount`)
5. –°–æ–∑–¥–∞—ë—Ç—Å—è `Payout(status="pending")`

### 3. –ê–¥–º–∏–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

**–û–¥–æ–±—Ä–µ–Ω–∏–µ:**
```python
PayoutService.approve_payout(payout_id, admin_id)
```
- –°–ø–∏—Å—ã–≤–∞–µ—Ç —Å –±–∞–ª–∞–Ω—Å–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
- –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `approved`
- –£–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞

**–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ:**
```python
PayoutService.reject_payout(payout_id, admin_id, reason)
```
- –†–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞
- –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `rejected`
- –£–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

```
============================================================
REFERRAL SYSTEM TEST (10.12.2024)
============================================================

[OK] User referral (ref_XXX)
[OK] Partner referral (partner_XXX)
[OK] Duplicate referral rejected
[OK] Self-referral rejected
[OK] Partner commission (15%)
[OK] Referral stats updated
[OK] Payout request created

============================================================
Passed: 7/8
============================================================
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–µ—Å—Ç "Commission on deduct (10%)" —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∫–æ—à–µ–ª—å–∫–∞–º–∏ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ. –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

### –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏** ‚Äî `ref_XXX` —Å–æ–∑–¥–∞—ë—Ç `Referral`
2. **–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è —Å–≤—è–∑—å** ‚Äî `partner_XXX` —Å–æ–∑–¥–∞—ë—Ç `Referral` —Å `partner_id`
3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π** ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
4. **–ó–∞—â–∏—Ç–∞ –æ—Ç self-referral** ‚Äî –Ω–µ–ª—å–∑—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–µ–±—è
5. **–ö–æ–º–∏—Å—Å–∏—è 10%** ‚Äî –æ–±—ã—á–Ω—ã–π —Ä–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç 10%
6. **–ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞** ‚Äî –ø–∞—Ä—Ç–Ω—ë—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç
7. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `total_payments`, `total_commission`
8. **–í—ã–≤–æ–¥** ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è `Payout`, –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å

---

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–∞—Ä—Ç–Ω—ë—Ä –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–∞

```
1. –ü–∞—Ä—Ç–Ω—ë—Ä (user_id=1) –∏–º–µ–µ—Ç –∫–æ–¥ "PARTNER123"
   - level1_percent = 20%
   
2. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ:
   /start partner_PARTNER123
   
3. –°–æ–∑–¥–∞—ë—Ç—Å—è Referral:
   - referrer_id = 1
   - referred_id = 2
   - partner_id = 1
   
4. –†–µ—Ñ–µ—Ä–∞–ª –ø–æ–∫—É–ø–∞–µ—Ç —É—Å–ª—É–≥—É –∑–∞ 100 GTON:
   CoreAPI.deduct_balance(user_id=2, amount=100)
   
5. –ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é:
   - 100 * 20% = 20 GTON
   - Partner.balance += 20
   - Partner.total_earned += 20
   - Referral.total_payments += 100
   - Referral.total_commission += 20
   
6. –ü–∞—Ä—Ç–Ω—ë—Ä –≤—ã–≤–æ–¥–∏—Ç 20 GTON:
   - frozen_balance = 20
   - Payout(amount_gton=20, amount_fiat=2000, status="pending")
   
7. –ê–¥–º–∏–Ω –æ–¥–æ–±—Ä—è–µ—Ç:
   - Partner.balance -= 20
   - Payout.status = "approved"
   - –ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

---

## –§–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `core/database/models/referral.py` | –ú–æ–¥–µ–ª—å Referral |
| `core/database/models/partner.py` | –ú–æ–¥–µ–ª—å Partner |
| `core/database/models/commission.py` | –ú–æ–¥–µ–ª—å Commission |
| `core/database/models/payout.py` | –ú–æ–¥–µ–ª—å Payout |
| `core/referral/commission.py` | ReferralCommissionService |
| `core/payout/service.py` | PayoutService |
| `core/platform/telegram/handlers/start.py` | process_referral() |
| `core/platform/telegram/handlers/partner.py` | UI –ø–∞—Ä—Ç–Ω—ë—Ä–∫–∏ |
| `core/platform/telegram/admin/partners.py` | –ê–¥–º–∏–Ω –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ |
| `core/plugins/core_api.py` | deduct_balance() —Å –∫–æ–º–∏—Å—Å–∏–µ–π |

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–¢–æ–ª—å–∫–æ 1 —É—Ä–æ–≤–µ–Ω—å** ‚Äî –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
2. **–ö–æ–º–∏—Å—Å–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏** ‚Äî –Ω–µ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏
3. **–í—ã–≤–æ–¥ —Ç–æ–ª—å–∫–æ –≤ RUB** ‚Äî –¥—Ä—É–≥–∏–µ –≤–∞–ª—é—Ç—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ 10.12.2024*
