# –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ FuBot

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.

---

## –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏–π

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `user` | –°–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| `payment` | –ü–ª–∞—Ç–µ–∂–∏ |
| `referral` | –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ |
| `subscription` | –ü–æ–¥–ø–∏—Å–∫–∏ |
| `service` | –°–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ |

---

## –°–æ–±—ã—Ç–∏—è —è–¥—Ä–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (`user`)

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `user:registered` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | - | `{referrer_id, platform}` |
| `user:onboarding_completed` | –ü—Ä–æ—à—ë–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ | - | - |
| `user:blocked` | –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω | - | `{reason}` |
| `user:unblocked` | –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω | - | - |
| `user:returned` | –í–µ—Ä–Ω—É–ª—Å—è –ø–æ—Å–ª–µ 7+ –¥–Ω–µ–π | –¥–Ω–µ–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è | - |
| `user:inactive` | –ù–µ–∞–∫—Ç–∏–≤–µ–Ω 30+ –¥–Ω–µ–π | –¥–Ω–µ–π | - |

### –ü–ª–∞—Ç–µ–∂–∏ (`payment`)

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `payment:initiated` | –ù–∞—á–∞–ª –æ–ø–ª–∞—Ç—É | —Å—É–º–º–∞ (—Ä—É–±) | `{method}` |
| `payment:completed` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | —Å—É–º–º–∞ (—Ä—É–±) | `{method, tokens}` |
| `payment:failed` | –ù–µ—É–¥–∞—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | —Å—É–º–º–∞ (—Ä—É–±) | `{method, error}` |
| `payment:first` | –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂ | —Å—É–º–º–∞ (—Ä—É–±) | `{method}` |

### –ë–∞–ª–∞–Ω—Å

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `balance:low` | –ë–∞–ª–∞–Ω—Å –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ | –±–∞–ª–∞–Ω—Å | - |
| `balance:zero` | –ë–∞–ª–∞–Ω—Å = 0 | - | - |
| `balance:topped_up` | –ü–æ–ø–æ–ª–Ω–µ–Ω | —Å—É–º–º–∞ | `{method}` |

### –†–µ—Ñ–µ—Ä–∞–ª—ã (`referral`)

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `referral:registered` | –†–µ—Ñ–µ—Ä–∞–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è | - | `{referrer_id, level}` |
| `referral:first_payment` | –†–µ—Ñ–µ—Ä–∞–ª —Å–¥–µ–ª–∞–ª –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂ | —Å—É–º–º–∞ | `{referrer_id}` |
| `referral:commission` | –ù–∞—á–∏—Å–ª–µ–Ω–∞ –∫–æ–º–∏—Å—Å–∏—è | —Å—É–º–º–∞ –∫–æ–º–∏—Å—Å–∏–∏ | `{from_user_id, level}` |

### –ü–∞—Ä—Ç–Ω—ë—Ä—ã

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `partner:applied` | –ü–æ–¥–∞–ª –∑–∞—è–≤–∫—É | - | - |
| `partner:approved` | –û–¥–æ–±—Ä–µ–Ω | - | `{approved_by}` |
| `partner:rejected` | –û—Ç–∫–ª–æ–Ω—ë–Ω | - | `{reason}` |
| `partner:payout_requested` | –ó–∞–ø—Ä–æ—Å–∏–ª –≤—ã–≤–æ–¥ | —Å—É–º–º–∞ | `{method}` |
| `partner:payout_completed` | –í—ã–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω | —Å—É–º–º–∞ | `{method}` |

### –ü–æ–¥–ø–∏—Å–∫–∏ (`subscription`)

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `subscription:activated` | –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ | —Ü–µ–Ω–∞ (—Ç–æ–∫–µ–Ω—ã) | `{plan, days, service_id}` |
| `subscription:renewed` | –ü—Ä–æ–¥–ª–µ–Ω–∞ | —Ü–µ–Ω–∞ | `{plan, service_id}` |
| `subscription:expired` | –ò—Å—Ç–µ–∫–ª–∞ | - | `{plan, service_id}` |
| `subscription:cancelled` | –û—Ç–º–µ–Ω–µ–Ω–∞ | - | `{plan, service_id}` |

---

## –°–æ–±—ã—Ç–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤

–°–µ—Ä–≤–∏—Å—ã —Ç—Ä–µ–∫–∞—é—Ç —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ `core.track_event()`. 
–°–æ–±—ã—Ç–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å `service:{service_id}:`.

### –ü—Ä–∏–º–µ—Ä: AI Psychologist

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `service:ai:first_visit` | –ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç | - | - |
| `service:ai:session_started` | –ù–∞—á–∞–ª —Å–µ—Å—Å–∏—é | - | `{mode}` |
| `service:ai:session_ended` | –ó–∞–∫–æ–Ω—á–∏–ª —Å–µ—Å—Å–∏—é | –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω) | `{messages_count}` |
| `service:ai:message_sent` | –û—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ | —Ç–æ–∫–µ–Ω—ã | `{mode: text/voice}` |
| `service:ai:voice_used` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –≥–æ–ª–æ—Å | - | `{gender}` |
| `service:ai:settings_changed` | –ò–∑–º–µ–Ω–∏–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | - | `{setting}` |

### –ü—Ä–∏–º–µ—Ä: Dice Game

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | Value | Properties |
|---------|----------|-------|------------|
| `service:dice:game_started` | –ù–∞—á–∞–ª –∏–≥—Ä—É | —Å—Ç–∞–≤–∫–∞ | - |
| `service:dice:bet_placed` | –°–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É | —Å—É–º–º–∞ | `{bet_type}` |
| `service:dice:won` | –í—ã–∏–≥—Ä–∞–ª | –≤—ã–∏–≥—Ä—ã—à | `{multiplier}` |
| `service:dice:lost` | –ü—Ä–æ–∏–≥—Ä–∞–ª | —Å—Ç–∞–≤–∫–∞ | - |

---

## –í–æ—Ä–æ–Ω–∫–∏

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂

```python
FUNNEL_REGISTRATION_TO_PAYMENT = [
    "user:registered",
    "user:onboarding_completed",
    "payment:initiated",
    "payment:completed"
]
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ–ø—ã—Ç–∫–∞ ‚Üí —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- –û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –ø–ª–∞—Ç—ë–∂

### –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è

```python
FUNNEL_REFERRAL = [
    "referral:registered",
    "referral:first_payment"
]
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- % —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤, —Å–¥–µ–ª–∞–≤—à–∏—Ö –ø–ª–∞—Ç—ë–∂
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–æ–¥–ø–∏—Å–∫–∏

```python
FUNNEL_SUBSCRIPTION = [
    "subscription:activated",
    "subscription:renewed"  # –∏–ª–∏ subscription:expired
]
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Retention –ø–æ–¥–ø–∏—Å–æ–∫
- Churn rate

---

## –ö–∞–∫ —Ç—Ä–µ–∫–∞—Ç—å —Å–æ–±—ã—Ç–∏—è

### –í —è–¥—Ä–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

–Ø–¥—Ä–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–µ–∫–∞–µ—Ç:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- –ü–ª–∞—Ç–µ–∂–∏
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ü–æ–¥–ø–∏—Å–∫–∏

### –í —Å–µ—Ä–≤–∏—Å–µ

```python
# –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–±—ã—Ç–∏–µ
await self.core.track_event("session_started", user_id)

# –° —á–∏—Å–ª–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
await self.core.track_event(
    "message_sent",
    user_id=user_id,
    value=tokens_spent
)

# –° –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
await self.core.track_event(
    "game_played",
    user_id=user_id,
    value=bet_amount,
    label="dice",
    properties={
        "bet_type": "even",
        "result": "win",
        "multiplier": 2
    }
)
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏—è –≤ –ë–î

```python
class Event(Base):
    __tablename__ = "events"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, index=True)
    
    category = Column(String(50), index=True)  # user, payment, service
    action = Column(String(100), index=True)   # registered, completed, etc.
    
    service_id = Column(String(100), index=True)
    
    label = Column(String(255))
    value = Column(Integer)
    properties = Column(JSON)
    
    session_id = Column(String(100), index=True)
    platform = Column(String(20))
    
    created_at = Column(DateTime, index=True)
```

---

## –û—Ç—á—ë—Ç—ã

### –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç

```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 01.12.2024

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
‚Ä¢ –ù–æ–≤—ã—Ö: 45
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö: 234
‚Ä¢ –í–µ—Ä–Ω—É–≤—à–∏—Ö—Å—è: 12

üí∞ –ü–ª–∞—Ç–µ–∂–∏:
‚Ä¢ –°—É–º–º–∞: 15,400 ‚ÇΩ
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 28
‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: 550 ‚ÇΩ

ü§ù –†–µ—Ñ–µ—Ä–∞–ª—ã:
‚Ä¢ –ù–æ–≤—ã—Ö: 8
‚Ä¢ –° –ø–ª–∞—Ç–µ–∂–∞–º–∏: 3
‚Ä¢ –ö–æ–º–∏—Å—Å–∏–∏: 1,200 ‚ÇΩ

üì¶ –°–µ—Ä–≤–∏—Å—ã:
‚Ä¢ AI Psychologist:
  - –°–µ—Å—Å–∏–π: 156
  - –°–æ–æ–±—â–µ–Ω–∏–π: 2,340
  - –í—ã—Ä—É—á–∫–∞: 8,500 —Ç–æ–∫–µ–Ω–æ–≤
```

### –í–æ—Ä–æ–Ω–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

```
üìä –í–æ—Ä–æ–Ω–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:     100 (100%)
    ‚Üì
–û–Ω–±–æ—Ä–¥–∏–Ω–≥:       85 (85%)
    ‚Üì
–ü–æ–ø—ã—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã:  32 (32%)
    ‚Üì
–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞: 24 (24%)

–ö–æ–Ω–≤–µ—Ä—Å–∏—è: 24%
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

```python
# settings
"analytics.enabled": True
"analytics.retention_days": 90      # –•—Ä–∞–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏—è N –¥–Ω–µ–π
"analytics.track_messages": False   # –¢—Ä–µ–∫–∞—Ç—å –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
"analytics.daily_report": True      # –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç
"analytics.report_chat_id": 123456  # –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç—á—ë—Ç
```

---

## –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

### CSV —ç–∫—Å–ø–æ—Ä—Ç

```python
# –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
admin:analytics:export

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
# - –ü–µ—Ä–∏–æ–¥: last_7_days, last_30_days, custom
# - –ö–∞—Ç–µ–≥–æ—Ä–∏—è: all, user, payment, service
# - –§–æ—Ä–º–∞—Ç: csv, json
```

### API (–±—É–¥—É—â–µ–µ)

```
GET /api/analytics/events?
    from=2024-01-01&
    to=2024-01-31&
    category=payment&
    limit=1000
```
