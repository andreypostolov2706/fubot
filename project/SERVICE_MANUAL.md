# üìò –ú–µ—Ç–æ–¥–∏—á–∫–∞ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —Å–µ—Ä–≤–∏—Å–æ–≤ FuBot

## –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–µ—Ä–≤–∏—Å?

**–°–µ—Ä–≤–∏—Å** ‚Äî —ç—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã–π –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±–æ—Ç–∞. –°–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç:
- –°–≤–æ—é –∫–Ω–æ–ø–∫—É –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
- –°–≤–æ—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –î–æ—Å—Ç—É–ø –∫ –±–∞–ª–∞–Ω—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ CoreAPI

**–ü—Ä–∏–º–µ—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤:**
- üß† –ò–ò-–ü—Å–∏—Ö–æ–ª–æ–≥ ‚Äî —á–∞—Ç —Å GPT
- üéÆ –ò–≥—Ä—ã ‚Äî –∫–∞–∑–∏–Ω–æ, —Å–ª–æ—Ç—ã
- üìö –ö—É—Ä—Å—ã ‚Äî –æ–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
- üõí –ú–∞–≥–∞–∑–∏–Ω ‚Äî –ø—Ä–æ–¥–∞–∂–∞ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TELEGRAM BOT                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ                    –Ø–î–†–û (core/)                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ –ë–∞–ª–∞–Ω—Å   ‚îÇ  ‚îÇ –ü–∞—Ä—Ç–Ω—ë—Ä—ã ‚îÇ  ‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  GTON    ‚îÇ  ‚îÇ –†–µ—Ñ–µ—Ä–∞–ª—ã ‚îÇ  ‚îÇ   –ù–∞—Å—Ç—Ä–æ–π–∫–∏  ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       ‚îÇ                                          ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       ‚ñº                                          ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ              CoreAPI                      ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚Ä¢ get_balance()    ‚Ä¢ set_user_state()   ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚Ä¢ deduct_balance() ‚Ä¢ track_event()      ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚Ä¢ add_balance()    ‚Ä¢ format_gton()      ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                      ‚îÇ                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ              –°–ï–†–í–ò–°–´ (services/)                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ–ò–ò-–ü—Å–∏—Ö–æ–ª–æ–≥ ‚îÇ  ‚îÇ   –ò–≥—Ä—ã     ‚îÇ  ‚îÇ  –ö—É—Ä—Å—ã   ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  —Å–≤–æ—è –ë–î   ‚îÇ  ‚îÇ  —Å–≤–æ—è –ë–î   ‚îÇ  ‚îÇ —Å–≤–æ—è –ë–î  ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å

### 1. –°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫

```
services/
‚îî‚îÄ‚îÄ my_service/
    ‚îú‚îÄ‚îÄ __init__.py          # –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª
    ‚îú‚îÄ‚îÄ service.py           # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å
    ‚îî‚îÄ‚îÄ requirements.txt     # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
```

### 2. –°–æ–∑–¥–∞–π—Ç–µ service.py

```python
"""
My Service ‚Äî –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Å–µ—Ä–≤–∏—Å–∞
"""
from decimal import Decimal
from core.plugins.base_service import (
    BaseService, ServiceInfo, MenuItem, Response,
    UserServiceDTO, CallbackContext, MessageContext, MessageDTO
)
from core.plugins.core_api import CoreAPI


class MyService(BaseService):
    """–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å"""
    
    @property
    def info(self) -> ServiceInfo:
        return ServiceInfo(
            id="my_service",           # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–ª–∞—Ç–∏–Ω–∏—Ü–∞, snake_case)
            name="–ú–æ–π –°–µ—Ä–≤–∏—Å",         # –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            description="–û–ø–∏—Å–∞–Ω–∏–µ",    # –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            version="1.0.0",
            author="–ê–≤—Ç–æ—Ä",
            icon="üéÆ"                  # –≠–º–æ–¥–∑–∏ –¥–ª—è –º–µ–Ω—é
        )
    
    async def install(self) -> bool:
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–∞"""
        return True
    
    async def uninstall(self) -> bool:
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞"""
        return True
    
    def get_user_menu_items(self, user_id: int, user_data: UserServiceDTO) -> list[MenuItem]:
        """–ö–Ω–æ–ø–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é"""
        return [
            MenuItem(
                text=f"{self.info.icon} {self.info.name}",
                callback=f"service:{self.info.id}:main",
                order=100  # –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–º–µ–Ω—å—à–µ = –≤—ã—à–µ)
            )
        ]
    
    def get_admin_menu_items(self) -> list[MenuItem]:
        """–ö–Ω–æ–ø–∫–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
        return []
    
    async def handle_callback(
        self, 
        user_id: int, 
        action: str, 
        params: dict,
        context: CallbackContext
    ) -> Response:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏.
        
        Callback "service:my_service:main" ‚Üí action="main", params={}
        Callback "service:my_service:play:123" ‚Üí action="play", params={"id": "123"}
        """
        if action == "main":
            return await self._show_main(user_id)
        
        return Response(text="‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")
    
    async def handle_message(
        self,
        user_id: int,
        message: MessageDTO,
        context: MessageContext
    ) -> Response:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞)"""
        return Response(text="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é")
    
    # === –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã ===
    
    async def _show_main(self, user_id: int) -> Response:
        """–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Å–µ—Ä–≤–∏—Å–∞"""
        # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å —Å —Ñ–∏–∞—Ç–Ω—ã–º —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–æ–º
        balance = await self.core.get_balance(user_id)
        balance_str = await self.core.format_gton(balance, with_fiat=True)
        
        text = f"""
{self.info.icon} <b>{self.info.name}</b>

üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {balance_str}

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–µ—Ä–≤–∏—Å!
"""
        
        keyboard = [
            [{"text": "üéØ –î–µ–π—Å—Ç–≤–∏–µ", "callback_data": f"service:{self.info.id}:action"}],
            [{"text": "‚óÄÔ∏è –ù–∞–∑–∞–¥", "callback_data": "main_menu"}]
        ]
        
        return Response(text=text, keyboard=keyboard)
```

### 3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å

–í —Ñ–∞–π–ª–µ `services/__init__.py` –¥–æ–±–∞–≤—å—Ç–µ:

```python
from .my_service.service import MyService
```

---

## CoreAPI ‚Äî –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã

### üí∞ –†–∞–±–æ—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–æ–º

```python
from decimal import Decimal

# –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å (GTON)
balance = await self.core.get_balance(user_id)
# ‚Üí Decimal("125.500000")

# –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —Å —Ñ–∏–∞—Ç–æ–º
gton, rub = await self.core.get_balance_with_fiat(user_id, "RUB")
# ‚Üí (Decimal("125.5"), Decimal("12550.0"))

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
text = await self.core.format_gton(balance, with_fiat=True)
# ‚Üí "125.5 GTON (~12,550 ‚ÇΩ)"

# –°–ø–∏—Å–∞—Ç—å GTON
result = await self.core.deduct_balance(
    user_id=user_id,
    amount=Decimal("0.5"),      # –°—É–º–º–∞ –≤ GTON
    reason="–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è", # –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
    action="chat_message"        # –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è
)

if result.success:
    print(f"–°–ø–∏—Å–∞–Ω–æ! –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {result.new_balance}")
else:
    print(f"–û—à–∏–±–∫–∞: {result.error}")
    # –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏:
    # - "Insufficient balance" ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
    # - "Wallet not found" ‚Äî –∫–æ—à–µ–ª—ë–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω
    # - "Invalid amount" ‚Äî –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞

# –ù–∞—á–∏—Å–ª–∏—Ç—å GTON (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–æ–∑–≤—Ä–∞—Ç)
result = await self.core.add_balance(
    user_id=user_id,
    amount=Decimal("1.0"),
    source="refund",
    reason="–í–æ–∑–≤—Ä–∞—Ç –∑–∞ –æ—à–∏–±–∫—É"
)
```

### üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç

```python
from decimal import Decimal

# RUB ‚Üí GTON
gton = await self.core.convert_to_gton(Decimal("100"), "RUB")
# ‚Üí Decimal("1.0")

# GTON ‚Üí RUB
rub = await self.core.convert_from_gton(Decimal("1.0"), "RUB")
# ‚Üí Decimal("100.0")

# –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã
rates = await self.core.get_gton_rates()
# ‚Üí {"TON": Decimal("1.53"), "USD": Decimal("10.0"), "RUB": Decimal("1000.0")}
```

### üìù FSM ‚Äî –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
await self.core.set_user_state(
    user_id=user_id,
    state="waiting_message",
    data={"session_id": 123, "step": 1}
)

# –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
state, data = await self.core.get_user_state(user_id)
# state = "waiting_message"
# data = {"session_id": 123, "step": 1}

# –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
await self.core.clear_user_state(user_id)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Response:**

```python
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ Response
return Response(
    text="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
    set_state="waiting_input",
    state_data={"context": "greeting"}
)

# –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ Response
return Response(
    text="–ì–æ—Ç–æ–≤–æ!",
    clear_state=True
)
```

### üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

```python
# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user = await self.core.get_user(telegram_id=123456789)
# user.id, user.first_name, user.language, user.role

# –ü–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫
lang = await self.core.get_user_language(user_id)
# ‚Üí "ru" –∏–ª–∏ "en"

# –ü–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
text = await self.core.get_text(user_id, "SECTION.key", name="–ò–≤–∞–Ω")
```

### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Ä–≤–∏—Å–µ

```python
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
await self.core.set_user_service_settings(user_id, {
    "voice_enabled": True,
    "model": "gpt-4",
    "temperature": 0.7
})

# –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
settings = await self.core.get_user_service_settings(user_id)
voice = settings.get("voice_enabled", False)
```

### üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

```python
# –¢—Ä–µ–∫–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
await self.core.track_event(
    event_name="message_sent",     # –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
    user_id=user_id,               # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    value=5,                       # –ß–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    properties={                   # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        "mode": "voice",
        "model": "gpt-4"
    }
)

# –°–æ–±—ã—Ç–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å —Å–µ—Ä–≤–∏—Å–∞:
# "message_sent" ‚Üí "service:my_service:message_sent"
```

### üîî –ü–æ–¥–ø–∏—Å–∫–∏

```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
sub = await self.core.check_subscription(user_id)

if sub.is_active:
    print(f"–ü–ª–∞–Ω: {sub.plan}, –æ—Å—Ç–∞–ª–æ—Å—å {sub.days_left} –¥–Ω–µ–π")
else:
    print("–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞")

# sub.is_active ‚Äî –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏
# sub.plan ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ ("basic", "premium")
# sub.expires_at ‚Äî –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
# sub.days_left ‚Äî –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å
```

---

## Response ‚Äî –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

```python
from core.plugins.base_service import Response

# –ü—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
return Response(text="–ü—Ä–∏–≤–µ—Ç!")

# –° –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
return Response(
    text="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
    keyboard=[
        [{"text": "–ö–Ω–æ–ø–∫–∞ 1", "callback_data": "service:my:action1"}],
        [{"text": "–ö–Ω–æ–ø–∫–∞ 2", "callback_data": "service:my:action2"}],
        [{"text": "‚óÄÔ∏è –ù–∞–∑–∞–¥", "callback_data": "main_menu"}]
    ]
)

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
return Response(
    text="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
    action="send"  # "edit" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), "send", "answer", "delete"
)

# –ü–æ–∫–∞–∑–∞—Ç—å alert
return Response(
    text="",
    action="answer",
    show_alert=True,
    alert_text="–û—à–∏–±–∫–∞! –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤."
)

# –° –º–µ–¥–∏–∞
return Response(
    text="–í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:",
    media_type="photo",
    media_file_id="AgACAgIAAxk..."  # –∏–ª–∏ media_url="https://..."
)

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
return Response(
    text="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
    set_state="waiting_input",
    state_data={"step": 1}
)

# –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π callback
return Response(
    text="",
    redirect_to="main_menu"
)
```

---

## –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–ª–∞—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ

```python
async def _do_action(self, user_id: int) -> Response:
    """–î–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å—Ç–æ–∏—Ç GTON"""
    from decimal import Decimal
    
    COST = Decimal("0.5")  # –°—Ç–æ–∏–º–æ—Å—Ç—å
    
    # –°–ø–∏—Å—ã–≤–∞–µ–º
    result = await self.core.deduct_balance(
        user_id=user_id,
        amount=COST,
        reason="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
        action="generate_image"
    )
    
    if not result.success:
        # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
        balance_str = await self.core.format_gton(
            result.new_balance or Decimal("0")
        )
        return Response(
            text=f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ GTON!\n\n"
                 f"–°—Ç–æ–∏–º–æ—Å—Ç—å: {COST} GTON\n"
                 f"–£ –≤–∞—Å: {balance_str}",
            keyboard=[
                [{"text": "üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "callback_data": "top_up"}],
                [{"text": "‚óÄÔ∏è –ù–∞–∑–∞–¥", "callback_data": f"service:{self.info.id}:main"}]
            ]
        )
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
    image_url = await self._generate_image()
    
    # –¢—Ä–µ–∫–∞–µ–º
    await self.core.track_event("image_generated", user_id, value=1)
    
    return Response(
        text="üé® –í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!",
        media_type="photo",
        media_url=image_url
    )
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ (FSM)

```python
async def handle_callback(self, user_id, action, params, context) -> Response:
    if action == "start_dialog":
        # –®–∞–≥ 1: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è
        return Response(
            text="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",
            set_state="waiting_name",
            state_data={"step": 1}
        )
    
    elif action == "main":
        return await self._show_main(user_id)
    
    return Response(text="‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")

async def handle_message(self, user_id, message, context) -> Response:
    state, data = await self.core.get_user_state(user_id)
    
    if state == "waiting_name":
        name = message.text
        # –®–∞–≥ 2: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç
        return Response(
            text=f"–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, {name}! –°–∫–æ–ª—å–∫–æ –≤–∞–º –ª–µ—Ç?",
            set_state="waiting_age",
            state_data={"name": name, "step": 2}
        )
    
    elif state == "waiting_age":
        name = data.get("name")
        age = message.text
        # –ó–∞–≤–µ—Ä—à–∞–µ–º –¥–∏–∞–ª–æ–≥
        return Response(
            text=f"–û—Ç–ª–∏—á–Ω–æ! {name}, {age} –ª–µ—Ç. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!",
            clear_state=True,
            keyboard=[
                [{"text": "‚óÄÔ∏è –í –º–µ–Ω—é", "callback_data": f"service:{self.info.id}:main"}]
            ]
        )
    
    return Response(text="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é")
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
async def _show_settings(self, user_id: int) -> Response:
    settings = await self.core.get_user_service_settings(user_id)
    
    voice = settings.get("voice_enabled", False)
    model = settings.get("model", "gpt-3.5")
    
    voice_icon = "‚úÖ" if voice else "‚ùå"
    
    text = f"""
‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>

üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {voice_icon}
ü§ñ –ú–æ–¥–µ–ª—å: {model}
"""
    
    keyboard = [
        [{"text": f"üé§ –ì–æ–ª–æ—Å: {voice_icon}", 
          "callback_data": f"service:{self.info.id}:toggle_voice"}],
        [{"text": "ü§ñ –í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å", 
          "callback_data": f"service:{self.info.id}:select_model"}],
        [{"text": "‚óÄÔ∏è –ù–∞–∑–∞–¥", 
          "callback_data": f"service:{self.info.id}:main"}]
    ]
    
    return Response(text=text, keyboard=keyboard)

async def _toggle_voice(self, user_id: int) -> Response:
    settings = await self.core.get_user_service_settings(user_id)
    current = settings.get("voice_enabled", False)
    
    await self.core.set_user_service_settings(user_id, {
        "voice_enabled": not current
    })
    
    return await self._show_settings(user_id)
```

---

## –°–≤–æ—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å—É –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (—Å–µ—Å—Å–∏–∏, –∏—Å—Ç–æ—Ä–∏—è, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞), —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ë–î:

### database/connection.py

```python
"""Database connection"""
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base

# –ë–î –≤ –ø–∞–ø–∫–µ —Å–µ—Ä–≤–∏—Å–∞
SERVICE_DIR = os.path.dirname(os.path.dirname(__file__))
DATA_DIR = os.path.join(SERVICE_DIR, "data")
os.makedirs(DATA_DIR, exist_ok=True)

DB_PATH = os.path.join(DATA_DIR, "service.db")
DATABASE_URL = f"sqlite:///{DB_PATH}"

engine = create_engine(DATABASE_URL, echo=False)
SessionLocal = sessionmaker(bind=engine)
Base = declarative_base()


def get_session():
    return SessionLocal()


def init_db():
    Base.metadata.create_all(engine)
```

### database/models.py

```python
"""Database models"""
from datetime import datetime
from sqlalchemy import Column, Integer, BigInteger, String, DateTime, Text, Boolean
from .connection import Base


class ChatSession(Base):
    """–°–µ—Å—Å–∏—è —á–∞—Ç–∞"""
    __tablename__ = "chat_sessions"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(BigInteger, nullable=False, index=True)
    
    title = Column(String(255))
    messages_count = Column(Integer, default=0)
    tokens_spent = Column(Integer, default=0)
    
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)


class ChatMessage(Base):
    """–°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ"""
    __tablename__ = "chat_messages"
    
    id = Column(Integer, primary_key=True)
    session_id = Column(Integer, index=True)
    
    role = Column(String(20))  # user, assistant, system
    content = Column(Text)
    tokens = Column(Integer, default=0)
    
    created_at = Column(DateTime, default=datetime.utcnow)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å–µ

```python
class MyService(BaseService):
    
    async def install(self) -> bool:
        from .database.connection import init_db
        init_db()
        return True
    
    async def _create_session(self, user_id: int) -> int:
        from .database.connection import get_session
        from .database.models import ChatSession
        
        with get_session() as db:
            session = ChatSession(user_id=user_id)
            db.add(session)
            db.commit()
            return session.id
    
    async def _get_user_sessions(self, user_id: int) -> list:
        from .database.connection import get_session
        from .database.models import ChatSession
        
        with get_session() as db:
            return db.query(ChatSession).filter(
                ChatSession.user_id == user_id,
                ChatSession.is_active == True
            ).order_by(ChatSession.updated_at.desc()).all()
```

---

## –ß–µ–∫–ª–∏—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- [ ] `services/my_service/__init__.py` ‚Äî –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
- [ ] `services/my_service/service.py` ‚Äî –∫–ª–∞—Å—Å —Å–µ—Ä–≤–∏—Å–∞
- [ ] –°–≤–æ–π—Å—Ç–≤–æ `info` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ
- [ ] –ú–µ—Ç–æ–¥ `install()` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞
- [ ] –ú–µ—Ç–æ–¥ `uninstall()` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ
- [ ] –ú–µ—Ç–æ–¥ `get_user_menu_items()` ‚Äî –∫–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é
- [ ] –ú–µ—Ç–æ–¥ `get_admin_menu_items()` ‚Äî –∫–Ω–æ–ø–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
- [ ] –ú–µ—Ç–æ–¥ `handle_callback()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
- [ ] –ú–µ—Ç–æ–¥ `handle_message()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:
- [ ] `database/` ‚Äî —Å–≤–æ—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] `locales/` ‚Äî –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å
- [ ] `requirements.txt` ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- [ ] `README.md` ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## FAQ

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

```python
# –í handle_callback –∏ handle_message –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ user_id ‚Äî —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID
# –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å telegram_id:
user = await self.core.get_user_by_id(user_id)
telegram_id = user.telegram_id
```

### –ö–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–Ω–µ callback?

–≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —è–¥—Ä–æ, –Ω–æ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ CoreAPI. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Response —Å action="send".

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?

–ü–æ–¥–ø–∏—Å–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `UserService`. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `check_subscription()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∞–¥–º–∏–Ω–∫—É?

–†–µ–∞–ª–∏–∑—É–π—Ç–µ `get_admin_menu_items()` –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –≤ `handle_callback()` –¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `admin`.

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 17.12.2024*
