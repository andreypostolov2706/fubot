# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —è–¥—Ä–∞ FuBot

## –°—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CORE DATABASE                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ   users     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   wallets   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇtransactions ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ         ‚îÇ                                                       ‚îÇ
‚îÇ         ‚ñº                                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ  partners   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  referrals  ‚îÇ     ‚îÇ   payouts   ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ         ‚îÇ                                                       ‚îÇ
‚îÇ         ‚ñº                                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ  services   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇuser_services‚îÇ     ‚îÇsubscriptions‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ   events    ‚îÇ     ‚îÇ broadcasts  ‚îÇ     ‚îÇ  settings   ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ promocodes  ‚îÇ     ‚îÇnotifications‚îÇ     ‚îÇdaily_bonuses‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇuser_warnings‚îÇ     ‚îÇ  user_bans  ‚îÇ     ‚îÇmoderation_log‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

> üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ–ø–∏—Å–∞–Ω—ã –≤:
> - [PROMOCODES.md](./PROMOCODES.md) ‚Äî –ø—Ä–æ–º–æ–∫–æ–¥—ã
> - [NOTIFICATIONS.md](./NOTIFICATIONS.md) ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã
> - [MODERATION.md](./MODERATION.md) ‚Äî –º–æ–¥–µ—Ä–∞—Ü–∏—è –∏ –±–∞–Ω—ã
> - [DAILY_BONUS.md](./DAILY_BONUS.md) ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã

---

## –¢–∞–±–ª–∏—Ü–∞ `users`

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã.

```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    
    # === –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã ===
    telegram_id = Column(BigInteger, unique=True, index=True)
    telegram_username = Column(String(255))
    # discord_id = Column(BigInteger, unique=True, index=True)  # –ë—É–¥—É—â–µ–µ
    # whatsapp_phone = Column(String(20), unique=True, index=True)  # –ë—É–¥—É—â–µ–µ
    
    # === –ü—Ä–æ—Ñ–∏–ª—å ===
    first_name = Column(String(255))
    last_name = Column(String(255))
    language = Column(String(10), default="ru")
    timezone = Column(String(50), default="Europe/Moscow")
    
    # === –°–∏—Å—Ç–µ–º–Ω–∞—è —Ä–æ–ª—å ===
    role = Column(String(20), default="user")  # user, admin, superadmin
    
    # === –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ ===
    referrer_id = Column(Integer, ForeignKey("users.id"), index=True)
    referral_code = Column(String(20), unique=True, index=True)
    
    # === –°—Ç–∞—Ç—É—Å ===
    is_active = Column(Boolean, default=True)
    is_blocked = Column(Boolean, default=False)
    block_reason = Column(String(500))
    blocked_at = Column(DateTime)
    
    # === –û–Ω–±–æ—Ä–¥–∏–Ω–≥ ===
    onboarding_completed = Column(Boolean, default=False)
    
    # === Timestamps ===
    created_at = Column(DateTime, default=datetime.utcnow, index=True)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
    last_activity_at = Column(DateTime, index=True)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `wallets`

–ö–æ—à–µ–ª—å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –û—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞ ‚Äî **GTON** (6 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π).

```python
class Wallet(Base):
    __tablename__ = "wallets"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    
    # === –¢–∏–ø ===
    wallet_type = Column(String(20), nullable=False, default="main")
    # main   - –æ—Å–Ω–æ–≤–Ω–æ–π (GTON)
    # bonus  - –±–æ–Ω—É—Å–Ω—ã–µ GTON (—Å–≥–æ—Ä–∞—é—Ç, –Ω–µ–ª—å–∑—è –≤—ã–≤–µ—Å—Ç–∏)
    
    # === –ë–∞–ª–∞–Ω—Å (GTON ‚Äî 6 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π) ===
    balance = Column(Numeric(18, 6), default=Decimal("0"))
    
    # === –ó–∞–º–æ—Ä–æ–∑–∫–∞ ===
    frozen = Column(Numeric(18, 6), default=Decimal("0"))
    
    # === –õ–∏–º–∏—Ç—ã ===
    daily_limit = Column(Numeric(18, 6))           # –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Ç—Ä–∞—Ç
    daily_spent = Column(Numeric(18, 6), default=Decimal("0"))
    daily_reset_at = Column(DateTime)
    
    # === –ë–æ–Ω—É—Å–Ω—ã–µ GTON ===
    expires_at = Column(DateTime)  # –ö–æ–≥–¥–∞ —Å–≥–æ—Ä–∞—é—Ç
    
    # === Timestamps ===
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
    
    __table_args__ = (
        UniqueConstraint('user_id', 'wallet_type', name='uq_user_wallet_type'),
    )
```

> ‚ö†Ô∏è **GTON** ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ –±–æ—Ç–∞. –¶–µ–ø–æ—á–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: ANY ‚Üí USD ‚Üí TON ‚Üí GTON

---

## –¢–∞–±–ª–∏—Ü–∞ `transactions`

–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º GTON.

```python
class Transaction(Base):
    __tablename__ = "transactions"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    wallet_id = Column(Integer, ForeignKey("wallets.id"), nullable=False)
    
    # === –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ ===
    type = Column(String(10), nullable=False, index=True)
    # credit - –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ
    # debit  - —Å–ø–∏—Å–∞–Ω–∏–µ
    
    # === –°—É–º–º–∞ (GTON) ===
    amount = Column(Numeric(18, 6), nullable=False)
    direction = Column(String(10), nullable=False)  # "credit" –∏–ª–∏ "debit"
    
    # === –ë–∞–ª–∞–Ω—Å (GTON) ===
    balance_before = Column(Numeric(18, 6))
    balance_after = Column(Numeric(18, 6))
    
    # === –ü–ª–∞—Ç—ë–∂ (–¥–ª—è deposit) ===
    payment_method = Column(String(30))      # ton, yookassa, crypto
    payment_id = Column(String(255))         # ID –≤ –ø–ª–∞—Ç—ë–∂–∫–µ
    payment_amount = Column(Numeric(18, 6))  # –°—É–º–º–∞ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–∞–ª—é—Ç–µ
    payment_currency = Column(String(10))    # RUB, USD, TON
    exchange_rate = Column(Numeric(18, 8))   # –ö—É—Ä—Å –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–ª–∞—Ç–µ–∂–∞
    
    # === –°–µ—Ä–≤–∏—Å (–¥–ª—è usage) ===
    service_id = Column(String(100), index=True)
    service_action = Column(String(100))
    service_data = Column(JSON)
    
    # === –†–µ—Ñ–µ—Ä–∞–ª ===
    referral_user_id = Column(Integer, ForeignKey("users.id"))
    referral_level = Column(Integer)
    
    # === –ò—Å—Ç–æ—á–Ω–∏–∫ –∏ –¥–µ–π—Å—Ç–≤–∏–µ ===
    source = Column(String(50))   # payment, bonus, referral, admin, service
    action = Column(String(50))   # deposit, usage, refund, commission
    reference_id = Column(String(100))  # –°–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–æ–º/–ø—Ä–æ–º–æ–∫–æ–¥–æ–º
    
    # === –û–ø–∏—Å–∞–Ω–∏–µ ===
    description = Column(String(500))
    
    # === –°—Ç–∞—Ç—É—Å ===
    status = Column(String(20), default="completed", index=True)
    # pending, completed, failed, cancelled
    
    # === Timestamps ===
    created_at = Column(DateTime, default=datetime.utcnow, index=True)
    completed_at = Column(DateTime)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `partners`

–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞. –ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ GTON.

```python
class Partner(Base):
    __tablename__ = "partners"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), unique=True, nullable=False)
    
    # === –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ ===
    referral_code = Column(String(50), unique=True, nullable=False, index=True)
    
    # === –ö–æ–º–∏—Å—Å–∏–∏ (%) ===
    level1_percent = Column(Numeric(5, 2), default=20.0)  # –ü—Ä—è–º—ã–µ
    level2_percent = Column(Numeric(5, 2), default=0.0)   # 2-–π —É—Ä–æ–≤–µ–Ω—å
    level3_percent = Column(Numeric(5, 2), default=0.0)   # 3-–π —É—Ä–æ–≤–µ–Ω—å
    
    # === –ë–∞–ª–∞–Ω—Å (GTON) ===
    balance = Column(Numeric(18, 6), default=0)           # –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å
    total_earned = Column(Numeric(18, 6), default=0)      # –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
    total_withdrawn = Column(Numeric(18, 6), default=0)   # –í—Å–µ–≥–æ –≤—ã–≤–µ–¥–µ–Ω–æ
    frozen_balance = Column(Numeric(18, 6), default=0)    # –ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞
    
    # === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
    total_referrals = Column(Integer, default=0)
    active_referrals = Column(Integer, default=0)
    
    # === –°—Ç–∞—Ç—É—Å ===
    status = Column(String(20), default="pending", index=True)
    # pending, active, blocked
    
    # === –ó–∞—è–≤–∫–∞ ===
    application_text = Column(Text)
    applied_at = Column(DateTime, default=datetime.utcnow)
    
    # === –û–¥–æ–±—Ä–µ–Ω–∏–µ ===
    approved_by = Column(Integer, ForeignKey("users.id"))
    approved_at = Column(DateTime)
    rejection_reason = Column(Text)
    
    # === Timestamps ===
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `referrals`

–°–≤—è–∑–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä ‚Üí —Ä–µ—Ñ–µ—Ä–∞–ª.

```python
class Referral(Base):
    __tablename__ = "referrals"
    
    id = Column(Integer, primary_key=True)
    
    # === –°–≤—è–∑–∏ ===
    referrer_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    referred_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    partner_id = Column(Integer, ForeignKey("partners.id"), index=True)
    
    # === –£—Ä–æ–≤–µ–Ω—å ===
    level = Column(Integer, default=1)  # 1, 2, 3
    
    # === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
    total_payments = Column(Numeric(12, 2), default=0)
    total_commission = Column(Numeric(12, 2), default=0)
    
    # === –°—Ç–∞—Ç—É—Å ===
    is_active = Column(Boolean, default=True)
    
    # === Timestamps ===
    created_at = Column(DateTime, default=datetime.utcnow, index=True)
    first_payment_at = Column(DateTime)
    last_payment_at = Column(DateTime)
    
    __table_args__ = (
        UniqueConstraint('referrer_id', 'referred_id', name='uq_referral_pair'),
    )
```

---

## –¢–∞–±–ª–∏—Ü–∞ `commissions`

–ò—Å—Ç–æ—Ä–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π. –°–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ `deduct_balance`.

```python
class Commission(Base):
    __tablename__ = "commissions"
    
    id = Column(Integer, primary_key=True)
    
    # === –£—á–∞—Å—Ç–Ω–∏–∫–∏ ===
    referrer_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    referred_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    referral_id = Column(Integer, ForeignKey("referrals.id"), index=True)
    
    # === –°—É–º–º—ã (GTON) ===
    source_amount = Column(Numeric(18, 6), nullable=False)      # –°–ø–∏—Å–∞–Ω–æ —É —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    commission_amount = Column(Numeric(18, 6), nullable=False)  # –ù–∞—á–∏—Å–ª–µ–Ω–æ —Ä–µ—Ñ–µ—Ä–µ—Ä—É
    commission_percent = Column(Numeric(5, 2), nullable=False)  # –ü—Ä–æ—Ü–µ–Ω—Ç
    
    # === –£—Ä–æ–≤–µ–Ω—å ===
    level = Column(Integer, default=1)  # 1 = –ø—Ä—è–º–æ–π —Ä–µ—Ñ–µ—Ä–µ—Ä
    
    # === –ò—Å—Ç–æ—á–Ω–∏–∫ ===
    service_id = Column(String(100))
    action = Column(String(100))
    
    # === –°–≤—è–∑–∏ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ ===
    source_transaction_id = Column(Integer, ForeignKey("transactions.id"))
    commission_transaction_id = Column(Integer, ForeignKey("transactions.id"))
    
    # === Timestamp ===
    created_at = Column(DateTime, default=datetime.utcnow, index=True)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `payouts`

–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤. –°—É–º–º—ã –≤ GTON + —Ñ–∏–∞—Ç —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç.

```python
class Payout(Base):
    __tablename__ = "payouts"
    
    id = Column(Integer, primary_key=True)
    partner_id = Column(Integer, ForeignKey("partners.id"), nullable=False, index=True)
    
    # === –°—É–º–º–∞ (GTON) ===
    amount_gton = Column(Numeric(18, 6), nullable=False)  # –ó–∞–ø—Ä–æ—à–µ–Ω–æ GTON
    fee_gton = Column(Numeric(18, 6), default=0)          # –ö–æ–º–∏—Å—Å–∏—è GTON
    
    # === –§–∏–∞—Ç —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç (–Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞—è–≤–∫–∏) ===
    amount_fiat = Column(Numeric(12, 2), nullable=False)  # –°—É–º–º–∞ –≤ RUB
    currency = Column(String(3), default="RUB")           # –í–∞–ª—é—Ç–∞
    gton_rate = Column(Numeric(12, 4), nullable=False)    # –ö—É—Ä—Å GTON/RUB
    
    # === –ú–µ—Ç–æ–¥ ===
    method = Column(String(30), nullable=False)  # card, sbp, crypto
    details = Column(JSON, nullable=False)       # {"card": "4276...", "bank": "Sber"}
    
    # === –°—Ç–∞—Ç—É—Å ===
    status = Column(String(20), default="pending", index=True)
    # pending, processing, completed, rejected, cancelled
    
    # === –û–±—Ä–∞–±–æ—Ç–∫–∞ ===
    processed_by = Column(Integer, ForeignKey("users.id"))
    processed_at = Column(DateTime)
    rejection_reason = Column(Text)
    
    # === –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ===
    user_comment = Column(Text)
    admin_comment = Column(Text)
    
    # === Timestamps ===
    created_at = Column(DateTime, default=datetime.utcnow, index=True)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `services`

–†–µ–µ—Å—Ç—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

```python
class Service(Base):
    __tablename__ = "services"
    
    id = Column(String(100), primary_key=True)  # "ai_psychologist"
    
    # === –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ===
    name = Column(String(255), nullable=False)
    description = Column(Text)
    version = Column(String(20))
    author = Column(String(255))
    icon = Column(String(10))  # –≠–º–æ–¥–∑–∏
    
    # === –ü—É—Ç–∏ ===
    install_path = Column(String(500))
    
    # === –°—Ç–∞—Ç—É—Å ===
    status = Column(String(20), default="active", index=True)
    # active, disabled, error, maintenance
    
    # === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
    config = Column(JSON, default={})
    
    # === –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ ===
    features = Column(JSON, default={})
    # {
    #   "subscriptions": true,
    #   "broadcasts": true,
    #   "partner_menu": false,
    #   "voice_messages": true
    # }
    
    # === –ü—Ä–∞–≤–∞ ===
    permissions = Column(JSON, default=[])
    
    # === –ü–æ—Ä—è–¥–æ–∫ –≤ –º–µ–Ω—é ===
    menu_order = Column(Integer, default=0)
    
    # === Timestamps ===
    installed_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
    
    # === –û—à–∏–±–∫–∏ ===
    last_error = Column(Text)
    last_error_at = Column(DateTime)
    error_count = Column(Integer, default=0)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `user_services`

–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–µ—Ä–≤–∏—Å–∞.

```python
class UserService(Base):
    __tablename__ = "user_services"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    service_id = Column(String(100), ForeignKey("services.id"), nullable=False, index=True)
    
    # === –†–æ–ª—å –≤ —Å–µ—Ä–≤–∏—Å–µ ===
    role = Column(String(30), default="user")  # user, vip, moderator, admin
    
    # === –ü–æ–¥–ø–∏—Å–∫–∞ ===
    subscription_plan = Column(String(50))
    subscription_until = Column(DateTime)
    subscription_auto_renew = Column(Boolean, default=False)
    
    # === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    settings = Column(JSON, default={})
    
    # === FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
    state = Column(String(100))
    state_data = Column(JSON)
    state_updated_at = Column(DateTime)
    
    # === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
    total_spent = Column(Integer, default=0)
    usage_count = Column(Integer, default=0)
    
    # === –°—Ç–∞—Ç—É—Å ===
    is_active = Column(Boolean, default=True)
    is_blocked = Column(Boolean, default=False)
    
    # === Timestamps ===
    first_use_at = Column(DateTime, default=datetime.utcnow)
    last_use_at = Column(DateTime)
    
    __table_args__ = (
        UniqueConstraint('user_id', 'service_id', name='uq_user_service'),
    )
```

---

## –¢–∞–±–ª–∏—Ü–∞ `subscriptions`

–ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–ø–∏—Å–æ–∫.

```python
class Subscription(Base):
    __tablename__ = "subscriptions"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    service_id = Column(String(100), ForeignKey("services.id"), nullable=False, index=True)
    
    # === –ü–ª–∞–Ω ===
    plan = Column(String(50), nullable=False)
    
    # === –ü–µ—Ä–∏–æ–¥ ===
    started_at = Column(DateTime, nullable=False)
    expires_at = Column(DateTime, nullable=False, index=True)
    
    # === –û–ø–ª–∞—Ç–∞ ===
    price = Column(Integer, nullable=False)
    transaction_id = Column(Integer, ForeignKey("transactions.id"))
    
    # === –°—Ç–∞—Ç—É—Å ===
    status = Column(String(20), default="active", index=True)
    # active, expired, cancelled, refunded
    
    # === –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ ===
    auto_renew = Column(Boolean, default=False)
    renewal_reminded = Column(Boolean, default=False)
    
    # === Timestamps ===
    created_at = Column(DateTime, default=datetime.utcnow)
    cancelled_at = Column(DateTime)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `events`

–ê–Ω–∞–ª–∏—Ç–∏–∫–∞.

```python
class Event(Base):
    __tablename__ = "events"
    
    id = Column(Integer, primary_key=True)
    
    # === –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ===
    user_id = Column(Integer, ForeignKey("users.id"), index=True)
    
    # === –°–æ–±—ã—Ç–∏–µ ===
    category = Column(String(50), nullable=False, index=True)
    # user, payment, service, referral, subscription
    
    action = Column(String(100), nullable=False, index=True)
    # user:registered, payment:completed, service:ai:message_sent
    
    # === –ò—Å—Ç–æ—á–Ω–∏–∫ ===
    service_id = Column(String(100), index=True)
    
    # === –î–∞–Ω–Ω—ã–µ ===
    label = Column(String(255))
    value = Column(Integer)
    properties = Column(JSON)
    
    # === –°–µ—Å—Å–∏—è ===
    session_id = Column(String(100), index=True)
    
    # === –ö–æ–Ω—Ç–µ–∫—Å—Ç ===
    platform = Column(String(20))
    
    # === Timestamp ===
    created_at = Column(DateTime, default=datetime.utcnow, index=True)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `broadcasts`

–†–∞—Å—Å—ã–ª–∫–∏.

```python
class Broadcast(Base):
    __tablename__ = "broadcasts"
    
    id = Column(Integer, primary_key=True)
    
    # === –ò—Å—Ç–æ—á–Ω–∏–∫ ===
    source = Column(String(20), default="admin")  # admin, service
    service_id = Column(String(100), ForeignKey("services.id"))
    
    # === –ö–æ–Ω—Ç–µ–Ω—Ç ===
    text = Column(Text, nullable=False)
    parse_mode = Column(String(10), default="HTML")
    
    # === –ú–µ–¥–∏–∞ ===
    media_type = Column(String(20))
    media_file_id = Column(String(255))
    
    # === –ö–Ω–æ–ø–∫–∏ ===
    buttons = Column(JSON)
    
    # === –ê—É–¥–∏—Ç–æ—Ä–∏—è ===
    target = Column(String(50), default="all")
    filters = Column(JSON)
    
    # === –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ===
    scheduled_at = Column(DateTime)
    
    # === –°—Ç–∞—Ç—É—Å ===
    status = Column(String(20), default="draft", index=True)
    # draft, scheduled, sending, paused, completed, cancelled
    
    # === –ü—Ä–æ–≥—Ä–µ—Å—Å ===
    total_recipients = Column(Integer, default=0)
    sent_count = Column(Integer, default=0)
    delivered_count = Column(Integer, default=0)
    failed_count = Column(Integer, default=0)
    
    # === –°–∫–æ—Ä–æ—Å—Ç—å ===
    send_rate = Column(Integer, default=30)
    
    # === Timestamps ===
    created_by = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    started_at = Column(DateTime)
    completed_at = Column(DateTime)
```

---

## –¢–∞–±–ª–∏—Ü–∞ `settings`

–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

```python
class Setting(Base):
    __tablename__ = "settings"
    
    key = Column(String(100), primary_key=True)
    
    # === –ó–Ω–∞—á–µ–Ω–∏–µ ===
    value = Column(Text, nullable=False)
    value_type = Column(String(20), default="string")
    # string, int, float, bool, json
    
    # === –û–ø–∏—Å–∞–Ω–∏–µ ===
    description = Column(Text)
    
    # === –ö–∞—Ç–µ–≥–æ—Ä–∏—è ===
    category = Column(String(50), index=True)
    # general, payments, referral, notifications, limits
    
    # === –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å ===
    is_editable = Column(Boolean, default=True)
    
    # === –ò–∑–º–µ–Ω–µ–Ω–∏–µ ===
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
    updated_by = Column(Integer, ForeignKey("users.id"))
```
