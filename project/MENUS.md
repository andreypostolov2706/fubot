# Меню и навигация

## Меню без сервисов

### Пользователь

```
🏠 Главное меню

💰 Баланс: 0 токенов

┌─────────────────────────┐
│ 💳 Пополнить            │
├─────────────────────────┤
│ ⚙️ Настройки            │
├─────────────────────────┤
│ ❓ Помощь               │
├─────────────────────────┤
│ 🤝 Партнёрская программа│
└─────────────────────────┘
```

### Админ

```
🔧 Админ-панель

┌─────────────────────────┐
│ 👥 Партнёры             │
│   ├─ Список партнёров   │
│   ├─ Заявки             │
│   └─ Заявки на вывод    │
├─────────────────────────┤
│ 📊 Статистика           │
│   ├─ Пользователи       │
│   ├─ Платежи            │
│   └─ Аналитика          │
├─────────────────────────┤
│ 📢 Рассылка             │
├─────────────────────────┤
│ ⚙️ Настройки            │
├─────────────────────────┤
│ 📦 Сервисы              │
│   ├─ Установленные      │
│   └─ Управление         │
└─────────────────────────┘
```

---

## Меню с сервисом (AI Psychologist)

### Пользователь

```
🏠 Главное меню

💰 Баланс: 150 токенов

┌─────────────────────────┐
│ 🧠 ИИ-Психолог          │  ← Кнопка от сервиса
├─────────────────────────┤
│ 💳 Пополнить            │
├─────────────────────────┤
│ ⚙️ Настройки            │
├─────────────────────────┤
│ ❓ Помощь               │
├─────────────────────────┤
│ 🤝 Партнёрская программа│
└─────────────────────────┘
```

При нажатии на "🧠 ИИ-Психолог":

```
🧠 ИИ-Психолог

Ваш личный психолог на базе ИИ.
Конфиденциально и безопасно.

💰 Баланс: 150 токенов

┌─────────────────────────┐
│ 💬 Начать сеанс         │
├─────────────────────────┤
│ 📋 Мои сеансы           │
├─────────────────────────┤
│ ⚙️ Настройки голоса     │
├─────────────────────────┤
│ ◀️ Назад                │
└─────────────────────────┘
```

### Админ

```
🔧 Админ-панель

┌─────────────────────────┐
│ 🧠 ИИ-Психолог          │  ← Админка сервиса
├─────────────────────────┤
│ 👥 Партнёры             │
├─────────────────────────┤
│ 📊 Статистика           │
├─────────────────────────┤
│ 📢 Рассылка             │
├─────────────────────────┤
│ ⚙️ Настройки            │
├─────────────────────────┤
│ 📦 Сервисы              │
└─────────────────────────┘
```

При нажатии на "🧠 ИИ-Психолог" (админ):

```
🧠 ИИ-Психолог — Админ

📊 Статистика:
• Пользователей: 1,234
• Сессий сегодня: 89
• Сообщений сегодня: 1,456

┌─────────────────────────┐
│ 📊 Детальная статистика │
├─────────────────────────┤
│ ⚙️ Настройки ИИ         │
├─────────────────────────┤
│ 💰 Тарифы               │
├─────────────────────────┤
│ 📢 Рассылка сервиса     │
├─────────────────────────┤
│ ◀️ Назад                │
└─────────────────────────┘
```

---

## Callback Data Format

### Ядро

```
main_menu              - Главное меню
top_up                 - Пополнение
top_up:100             - Пополнить на 100 руб
settings               - Настройки
settings:language      - Настройки языка
help                   - Помощь
partner                - Партнёрская программа
partner:stats          - Статистика партнёра
partner:payout         - Вывод средств

admin                  - Админ-панель
admin:users            - Пользователи
admin:partners         - Партнёры
admin:payouts          - Заявки на вывод
admin:stats            - Статистика
admin:broadcast        - Рассылка
admin:settings         - Настройки
admin:services         - Сервисы
```

### Сервисы

```
service:{service_id}:{action}:{params}

Примеры:
service:ai_psychologist:main
service:ai_psychologist:start_session
service:ai_psychologist:session:123
service:ai_psychologist:settings
service:ai_psychologist:admin
service:ai_psychologist:admin:stats
```

---

## Формирование меню

### Как ядро собирает меню

```python
# core/platform/telegram/handlers.py

async def show_main_menu(user_id: int):
    """Показать главное меню"""
    
    # Получаем пользователя
    user = await core.get_user_by_id(user_id)
    balance = await core.get_balance(user_id)
    
    # Базовые кнопки
    menu_items = [
        MenuItem(text="💳 Пополнить", callback="top_up", order=100),
        MenuItem(text="⚙️ Настройки", callback="settings", order=200),
        MenuItem(text="❓ Помощь", callback="help", order=300),
        MenuItem(text="🤝 Партнёрская программа", callback="partner", order=400),
    ]
    
    # Добавляем кнопки от сервисов
    for service in ServiceRegistry.get_active():
        user_data = await core.get_user_service_data(user_id, service.info.id)
        service_items = service.get_user_menu_items(user_id, user_data)
        menu_items.extend(service_items)
    
    # Сортируем по order
    menu_items.sort(key=lambda x: x.order)
    
    # Формируем клавиатуру
    keyboard = []
    for item in menu_items:
        if item.visible:
            keyboard.append([{
                "text": item.text + (f" {item.badge}" if item.badge else ""),
                "callback_data": item.callback
            }])
    
    text = f"""
🏠 <b>Главное меню</b>

💰 Баланс: {balance} токенов
"""
    
    return text, keyboard
```

### Как сервис добавляет кнопки

```python
# services/ai_psychologist/service.py

def get_user_menu_items(self, user_id: int, user_data) -> list[MenuItem]:
    """Пункты меню для пользователя"""
    
    items = [
        MenuItem(
            text="🧠 ИИ-Психолог",
            callback=f"service:{self.info.id}:main",
            order=10,  # Первым в списке
            visible=True
        )
    ]
    
    # Можно добавить badge
    if user_data.subscription_plan == "premium":
        items[0].badge = "⭐"
    
    return items
```

---

## Навигация

### Кнопка "Назад"

Каждый экран должен иметь кнопку возврата:

```python
# В меню сервиса
keyboard = [
    [{"text": "💬 Начать", "callback_data": f"service:{self.info.id}:start"}],
    [{"text": "◀️ Назад", "callback_data": "main_menu"}]  # Возврат в главное меню
]

# Во вложенном меню сервиса
keyboard = [
    [{"text": "...", "callback_data": "..."}],
    [{"text": "◀️ Назад", "callback_data": f"service:{self.info.id}:main"}]  # Возврат в меню сервиса
]
```

### Breadcrumbs (путь)

Для сложных меню можно показывать путь:

```
🧠 ИИ-Психолог → Настройки → Голос

Выберите голос:

┌─────────────────────────┐
│ 👩 Женский              │
├─────────────────────────┤
│ 👨 Мужской              │
├─────────────────────────┤
│ ◀️ Назад                │
└─────────────────────────┘
```

---

## Партнёрское меню

### Обычный пользователь

```
🤝 Партнёрская программа

Приглашайте друзей и получайте 20% 
от их платежей!

📊 Ваша статистика:
• Рефералов: 0
• Заработано: 0 ₽

🔗 Ваша ссылка:
t.me/bot?start=ref_ABC123

┌─────────────────────────┐
│ 📋 Мои рефералы         │
├─────────────────────────┤
│ 💰 Стать партнёром      │
├─────────────────────────┤
│ ◀️ Назад                │
└─────────────────────────┘
```

### Партнёр

```
🤝 Партнёрский кабинет

💰 Баланс: 1,500 ₽
📊 Всего заработано: 5,000 ₽

👥 Рефералы:
• Всего: 25
• Активных: 18

🔗 Ваша ссылка:
t.me/bot?start=partner_XYZ

┌─────────────────────────┐
│ 📋 Мои рефералы         │
├─────────────────────────┤
│ 💸 Вывести средства     │
├─────────────────────────┤
│ 📊 Статистика           │
├─────────────────────────┤
│ 🎁 Бонусные ссылки      │
├─────────────────────────┤
│ ◀️ Назад                │
└─────────────────────────┘
```

---

## Пополнение баланса

```
💳 Пополнение баланса

Текущий баланс: 50 токенов
Курс: 1 токен = 1 ₽

Выберите сумму:

┌─────────────────────────┐
│ 100 ₽ → 100 токенов     │
├─────────────────────────┤
│ 300 ₽ → 300 токенов     │
├─────────────────────────┤
│ 500 ₽ → 500 токенов     │
├─────────────────────────┤
│ 1000 ₽ → 1000 токенов   │
├─────────────────────────┤
│ 💬 Другая сумма         │
├─────────────────────────┤
│ ◀️ Назад                │
└─────────────────────────┘
```

После выбора:

```
💳 Оплата

Сумма: 300 ₽
Получите: 300 токенов

Выберите способ оплаты:

┌─────────────────────────┐
│ 💳 Банковская карта     │
├─────────────────────────┤
│ 📱 СБП                  │
├─────────────────────────┤
│ 🟡 ЮMoney               │
├─────────────────────────┤
│ ₿ Криптовалюта          │
├─────────────────────────┤
│ ◀️ Назад                │
└─────────────────────────┘
```
